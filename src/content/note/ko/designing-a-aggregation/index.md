---
title: Designing a aggregation
timestamp: 2026-01-07 02:56:32+09:00
toc: true
draft: true
tags:
  - learn/design
  - tech/backend
---

# 대시보드에서의 집계 구조 선택

DB에 데이터가 많아지면 가보자가보자
대시보드를 운영하다 보면, 어느 시점부터 성능 문제가 눈에 띄게 드러난다.
이 글은 대시보드 응답 시간이 점점 느려지는 상황에서, 여러 대안을 검토한 끝에 **Rollup Table 기반 집계 구조**를 선택하게 된 과정을 정리한 기록이다.

---

# 문제의 시작

우리가 운영하던 대시보드는 기간별 매출, 광고비, 수익 지표를 조회하는 구조였다.
초기에는 단순한 집계 쿼리로 충분했지만, 데이터가 쌓이면서 상황이 달라졌다.

* 조회 쿼리는 점점 복잡해졌고
* 데이터 볼륨이 증가하면서
* p99 기준 응답 시간이 10초를 넘기기 시작했다

일부 고객은 대시보드를 실시간 의사결정 도구로 사용하고 있었기 때문에, 이 지연은 명확한 문제였다.
단순한 인덱스 튜닝이나 쿼리 최적화만으로는 한계가 있다고 판단했다.

---

# 이 문제의 제약 조건

이 문제는 일반적인 “분석 쿼리가 느리다”는 문제와는 조금 달랐다.

가장 큰 특이점은 다음과 같다.

* 사용자가 **원가, 수수료, 배달비** 같은 값을 직접 입력하거나 수정한다
* 이 값은 집계 결과에 즉시 반영되어야 한다
* 모든 데이터를 다시 계산하는 방식은 현실적이지 않다

즉,

* 빠른 조회 성능이 필요하면서도
* **부분 재계산**이 가능해야 하고
* 운영 복잡도는 최소화해야 했다

이 제약 조건을 기준으로 여러 옵션을 검토했다.

---

# 옵션 1: PostgreSQL Materialized View

첫 번째로 고려한 것은 PostgreSQL의 Materialized View였다.

## 접근 방식

* 기간별 집계를 MV로 미리 계산해두고
* 조회 시에는 계산 없이 결과만 읽는다

## 장점

* 기존 OLTP 환경을 유지할 수 있다
* 별도의 인프라 도입이 필요 없다

## 문제점

* 데이터 삽입이 잦고
* 사용자 입력으로 인해 집계 결과가 자주 변경된다
* 이 경우 `REFRESH MATERIALIZED VIEW` 자체가 새로운 병목이 된다
* 특정 기간이나 일부 값만 선택적으로 갱신하기도 어렵다

결과적으로, **계산 비용을 조회 시점에서 갱신 시점으로 옮겼을 뿐**이라는 결론에 도달했다.
이 옵션은 제외했다.

---

# 옵션 2: OLAP 도입

다음으로는 OLAP 시스템 도입을 검토했다.

## 접근 방식

* 판매·광고 데이터를 배치로 OLAP에 적재
* 대시보드 조회를 OLTP에서 완전히 분리

## 장점

* 복잡한 집계 쿼리에도 안정적인 성능
* 동시 접근이 많아도 OLTP 부하와 분리 가능

## 현실적인 문제

1. **운영 복잡도**

   * 배치 적재
   * 백필
   * 재처리
   * 파이프라인 모니터링
     소규모 팀에서 감당하기에는 부담이 컸다.

2. **사용자 수기 입력 값**

   * 원가·수수료 같은 값은 OLAP 외부에서 발생한다
   * 이를 즉시 반영하려면 재적재·재집계가 필요하다
   * 정합성 관리 비용이 빠르게 증가한다

OLAP은 이론적으로는 깔끔한 해법이지만,
이 문제에서는 **과한 선택**이라고 판단했다.

---

# 최종 선택: Rollup Table

최종적으로 선택한 방식은 **Rollup Table**이었다.

## 접근 방식

* 기간 단위로 집계된 결과를 저장하는 테이블을 별도로 운영
* 다음 두 시점에 비동기적으로 집계 데이터를 갱신

  * 크롤링 완료 시점
  * 사용자가 원가·수수료·배달비 등을 입력 또는 수정했을 때

## 이 방식이 맞았던 이유

* 특정 기간, 특정 아이템 단위로 **부분 재계산이 가능**
* 조회는 단순한 SELECT 쿼리
* OLAP 대비 인프라 및 운영 비용이 매우 낮다

## 단점

* 사전에 정의되지 않은 차원에 대한 쿼리는 어렵다
* 복잡한 ad-hoc 분석에는 적합하지 않다

다만,

* 사용자 조회 로그를 분석했고
* 고객사 인터뷰를 통해 사용 패턴을 확인한 결과
  ad-hoc 쿼리는 거의 사용되지 않고 있었다.

이 문제에서는 **불필요한 유연성을 포기하는 것이 합리적**이었다.

---

# 결과

Rollup Table 기반 조회 구조로 전환한 이후,

* 대시보드 p99 응답 시간은
  **10초 수준에서 1초 미만**으로 감소했다
* 조회 쿼리는 단순해졌고
* 데이터 변경이 발생해도 필요한 범위만 갱신할 수 있게 되었다

추가적인 인프라 도입 없이, 기존 시스템 구조 안에서 해결할 수 있었다.

---

## 정리하며

이 문제를 통해 다시 확인한 점은 단순하다.

* 항상 더 강력한 아키텍처가 정답은 아니다
* 중요한 것은

  * 실제 사용자 행동
  * 조직의 운영 역량
  * 감당 가능한 복잡도

Rollup Table은 범용적인 해법은 아니지만,
이 문제의 제약 조건 안에서는 가장 현실적인 선택이었다.
