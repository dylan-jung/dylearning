---
title: Designing a Subscription System - Requirements
timestamp: 2025-08-13
toc: true
tags:
  - learn/design
  - tech/backend
draft: true
---

### 기능적 요구사항

- 구독 플랜
  - Free 플랜 제공. Free은 유료 구독 없이도 제한적 기능 접근이 가능해야 한다.
  - 유료 플랜은 월간 구독과 연간 구독을 제공한다.
  - 구독 수준(예: Freemium, Standard, Pro 등)에 따른 권한/기능 플래그를 정의하고, 인증된 요청 처리 시 권한 검증을 수행한다.
- 구독 수명주기
  - 구독 시작: 카드결제만을 지원한다. 결제할 카드를 등록하고, 결제 승인 성공 시점에 구독 상태를 활성화로 전환한다.
  - 카드변경: 카드 변경은 구현하지 않는다.
  - 갱신: 다음 결제 예정일에 자동 결제를 시도하고 성공 시 구독 기간을 연장한다.
  - 취소: 사용자가 구독을 취소하면 자동 갱신만 중단한다. 취소 후에도 현재 결제 주기 종료 시점까지 접근 권한을 유지한다.
  - 만료: 결제 실패 또는 취소로 인해 다음 결제 시도가 성사되지 않으면 주기 종료 시점에 구독을 만료 상태로 전환하고 권한을 회수한다.
- 과금 주기 및 기간 산정
  - 결제 주기는 “다음달의 같은 날짜”를 기준으로 산정한다. 같은 날짜가 존재하지 않는 경우 말일로 보정한다(예: 1월 31일 → 2월 29/28일 → 3월 31일).
  - 접근 가능 기간은 결제 시작일로부터 다음 결제 예정일까지 유효하도록 설정한다. 시간 경계는 시스템 표준 시간대 기준으로 정의한다.
  - 결제 예정일에 자동 결제를 시도한다. 성공 시 다음 주기를 동일 규칙으로 갱신한다.
- 결제 처리
  - 결제 게이트웨이를 통해 카드 결제(토큰화 기반)를 지원한다.
  - 결제 요청은 멱등성을 보장해야 한다(요청 키 기준 중복 실행 방지).
  - 결제 승인/실패/취소/환불(미포함 정책)이벤트를 구독 도메인 이벤트로 변환하여 상태 전이를 일관되게 처리한다.
- 인보이스/영수증
  - 각 결제 시도마다 인보이스를 생성하고, 결제 성공 시 영수증(결제 ID, 금액 등)을 발행한다.
  - 사용자와 관리자 화면에서 결제 내역, 다음 결제 예정일, 현재 플랜/상태를 확인할 수 있다.
- 실패 처리 및 재시도
  - 유저의 실책(금액 부족 등)에 의한 자동 결제 실패 시에는 재시도 정책을 적용한다.
  - 다만 상세한 재시도 정책은 구현하지 않는다.
  - 재시도 실패 후 최종 실패 처리 시 구독을 만료 상태로 전환한다.

### 비기능적 요구사항

- 가용성/신뢰성
  - 결제/갱신 경로는 99.9% 이상 가용성을 목표로 한다.
  - 결제/상태 전이 로직은 멱등적이어야 하며, 중복 웹훅/재전송에도 일관된 결과를 보장한다.
  - 외부 게이트웨이 장애 시 큐잉 및 재시도 메커니즘을 통해 작업 유실을 방지한다.
- 일관성/정합성
  - 결제 결과와 구독 상태는 최종적 일관성을 보장하되, 사용자-facing 정보는 지연 허용 범위를 SLA로 정의한다(예: 1분 이내).
  - 시간 계산 로직은 단일 소스(도메인 서비스)로 통일하여 경계 케이스의 불일치를 방지한다.
- 보안/컴플라이언스
  - 전송 구간 암호화(TLS), 비밀번호/토큰 보안 저장, 최소 권한 원칙을 준수한다.
  - 개인정보 보호법 및 세무/영수증 관련 규정을 준수한다. 카드정보 취급 시 PCI-DSS 준수 범위를 명확히 한다.
- 성능/확장성
  - 결제 시도 API p95 응답시간 목표를 설정한다(예: 500ms 이내, 외부 결제 승인 대기 제외).
  - 배치/스케줄러 기반의 대규모 동시 갱신을 처리할 수 있도록 수평 확장을 지원한다(샤딩/분할 배치).
- 운영성
  - 재처리 도구: 잘못된 상태를 감지/교정할 수 있는 관리 콘솔, 재처리 큐 제공.
  - 설정 가능 항목을 외부화한다(재시도 정책, 시간대, 유예기간, 알림 템플릿 등).

### 명시적 제외/제약

- 환불 프로세스는 범위에 포함하지 않는다.
- 업그레이드/다운그레이드에 따른 부분 환불/일할 계산(proration)은 범위에서 제외한다.
